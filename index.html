<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLA Daily Journal + Auto-Save</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Style for textareas to ensure good readability and height */
        textarea {
            min-height: 8rem; /* Default minimum height */
            resize: vertical; /* Allow vertical resizing */
        }
        @media (min-width: 768px) {
            textarea {
                min-height: 6rem; /* Slightly smaller on larger screens if needed */
            }
        }
        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 lg:p-12 text-gray-800">

    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-xl p-6 md:p-8 lg:p-10 border border-gray-200">
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-2 rounded-lg p-2 inline-block bg-blue-50">MLA Daily Journal</h1>
            <p id="current-date" class="text-xl font-medium text-gray-600 mt-2"></p>
            <p class="text-xs text-green-600 mt-1 font-semibold" id="auto-save-indicator" style="opacity: 0; transition: opacity 0.5s;">Saved to browser storage ‚úì</p>
        </div>

        <div class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-blue-700 mb-4 flex items-center">
                <span class="mr-3 text-3xl">üìñ</span> Scripture Reflection
            </h2>

            <div class="mb-4">
                <label for="scripture-theme-select" class="block text-lg font-medium text-gray-700 mb-2">
                    Select a Theme:
                </label>
                <select id="scripture-theme-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm transition duration-150 ease-in-out">
                    <option value="">-- Choose a Theme --</option>
                    <option value="Hope">Hope</option>
                    <option value="Strength">Strength</option>
                    <option value="Guidance">Guidance</option>
                    <option value="Peace">Peace</option>
                    <option value="Love">Love</option>
                    <option value="Faith">Faith</option>
                    <option value="Provision">Provision</option>
                    <option value="Forgiveness">Forgiveness</option>
                    <option value="Wisdom">Wisdom</option>
                    <option value="Patience">Patience</option>
                    <option value="Joy">Joy</option>
                    <option value="Other">Other (Specify Below)</option>
                </select>
            </div>

            <div id="custom-theme-input-group" class="mb-4 hidden">
                <label for="custom-scripture-theme" class="block text-lg font-medium text-gray-700 mb-2">
                    Specify Custom Theme:
                </label>
                <input type="text" id="custom-scripture-theme" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm transition duration-150 ease-in-out" placeholder="e.g., Perseverance, Humility, Grace">
            </div>

            <div class="mb-6 text-center">
                <button id="generate-scripture-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    Generate Scripture
                </button>
                <span id="scripture-loading-spinner" class="loading-spinner hidden"></span>
            </div>

            <label for="generated-scripture-display" class="block text-lg font-medium text-gray-700 mb-2">
                Generated Scripture:
            </label>
            <div id="generated-scripture-display" class="text-lg text-gray-700 leading-relaxed mb-4 p-4 bg-white rounded-lg border border-gray-200 shadow-sm min-h-[100px] overflow-auto">
                Select a theme (or specify 'Other') and click "Generate Scripture" to get a passage.
            </div>

            <label for="scripture-reflection-input" class="block text-lg font-medium text-gray-700 mb-2 flex items-center">
                <span class="mr-2 text-2xl">üñä</span> What stands out to me in this passage?
                <span class="ml-2 text-sm italic text-gray-500"> ‚Äî Focus on your key takeaways from the scripture.</span>
            </label>
            <textarea id="scripture-reflection-input" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm transition duration-150 ease-in-out" placeholder="My key takeaways and reflections on the scripture..."></textarea>
        </div>

        <div class="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg shadow-md">
            <label for="mood-check-in-input" class="block text-xl font-medium text-gray-700 mb-2 flex items-center">
                <span class="mr-2 text-2xl">üòä</span> Mood Check-in
                <span class="ml-2 text-sm italic text-gray-500"> ‚Äî Describe how you feel and why.</span>
            </label>
            <textarea id="mood-check-in-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm transition duration-150 ease-in-out" placeholder="Today I feel ___ because ___. (e.g., Today I feel grateful because I had a productive morning.)"></textarea>
        </div>

        <div class="mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-lg shadow-md">
            <label for="what-happened-today-input" class="block text-xl font-medium text-gray-700 mb-2 flex items-center">
                <span class="mr-2 text-2xl">üìÖ</span> What Happened Today?
                <span class="ml-2 text-sm italic text-gray-500"> ‚Äî Note key events, conversations, struggles, or small wins.</span>
            </label>
            <textarea id="what-happened-today-input" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 shadow-sm transition duration-150 ease-in-out" placeholder="Notable moments: (meetings, conversations, struggles, small wins)&#10;e.g., - Had a great team meeting about the new project.&#10;- Struggled with a challenging coding bug for an hour.&#10;- Celebrated a small win by finishing an urgent task."></textarea>
        </div>

        <div class="mb-8 p-6 bg-purple-50 border border-purple-200 rounded-lg shadow-md">
            <label for="spiritual-sense-input" class="block text-xl font-medium text-gray-700 mb-2 flex items-center">
                <span class="mr-2 text-2xl">üïäÔ∏è</span> What Did I Hear from God or Sense Spiritually?
                <span class="ml-2 text-sm italic text-gray-500"> ‚Äî Reflect on spiritual insights or messages received.</span>
            </label>
            <textarea id="spiritual-sense-input" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm transition duration-150 ease-in-out" placeholder="I feel God may be saying/showing me ___. (e.g., I feel God may be saying/showing me to trust more in His provision even when things are uncertain.)"></textarea>
        </div>

        <div class="mb-8 p-6 bg-red-50 border border-red-200 rounded-lg shadow-md">
            <label for="pattern-noticed-input" class="block text-xl font-medium text-gray-700 mb-2 flex items-center">
                <span class="mr-2 text-2xl">üß†</span> Self-Awareness + Insight
                <span class="ml-2 text-sm italic text-gray-500"> ‚Äî Identify patterns and their potential meaning.</span>
            </label>
            <textarea id="pattern-noticed-input" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 shadow-sm transition duration-150 ease-in-out mb-4" placeholder="I noticed a pattern or thought: ___. (e.g., I noticed a pattern of procrastinating on challenging tasks.)"></textarea>
            <textarea id="meaning-insight-input" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 shadow-sm transition duration-150 ease-in-out" placeholder="This could mean ___. (e.g., This could mean I need to break down tasks into smaller steps or address underlying anxiety.)"></textarea>
        </div>

        <div class="mb-8 p-6 bg-indigo-50 border border-indigo-200 rounded-lg shadow-md">
            <label for="prayer-request-input" class="block text-xl font-medium text-gray-700 mb-2 flex items-center">
                <span class="mr-2 text-2xl">üôè</span> Next Step or Prayer
                <span class="ml-2 text-sm italic text-gray-500"> ‚Äî State your prayer requests and tomorrow's focus.</span>
            </label>
            <textarea id="prayer-request-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out mb-4" placeholder="Lord, I need help with ___. (e.g., Lord, I need help with managing my time effectively and prioritizing tasks.)"></textarea>
            <textarea id="tomorrow-focus-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out" placeholder="Tomorrow I want to ___. (e.g., Tomorrow I want to start my day with prayer and focus on one major task before checking emails.)"></textarea>
        </div>

        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-10">
            <button id="save-journal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                Save Journal Entry
            </button>
            <button id="clear-form-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-gray-300">
                Start New Entry (Clear)
            </button>
        </div>
    </div>

    <div id="saveModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Journal Entry Saved!</h3>
            <p class="text-lg text-gray-700 mb-4">Your journal entry has been downloaded as a text file.</p>
            <p class="text-md text-gray-600 mb-6">
                <strong>Tip:</strong> The form is still saved in your browser. Click "Start New Entry" at the bottom if you want to clear it for tomorrow.
            </p>
            <button id="okModalBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300">
                OK
            </button>
        </div>
    </div>

    <script>
        // Set the current date dynamically
        document.addEventListener('DOMContentLoaded', () => {
            const dateElement = document.getElementById('current-date');
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            const formattedDate = today.toLocaleDateString('en-US', options);
            const dateForFilename = today.toISOString().slice(0, 10); //YYYY-MM-DD
            dateElement.textContent = formattedDate;

            // Elements
            const scriptureThemeSelect = document.getElementById('scripture-theme-select');
            const customThemeInputGroup = document.getElementById('custom-theme-input-group');
            const customScriptureThemeInput = document.getElementById('custom-scripture-theme');
            const generateScriptureBtn = document.getElementById('generate-scripture-btn');
            const generatedScriptureDisplay = document.getElementById('generated-scripture-display');
            const scriptureLoadingSpinner = document.getElementById('scripture-loading-spinner');
            const saveButton = document.getElementById('save-journal-btn');
            const clearButton = document.getElementById('clear-form-btn');
            const saveModal = document.getElementById('saveModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const okModalBtn = document.getElementById('okModalBtn');
            const autoSaveIndicator = document.getElementById('auto-save-indicator');

            // --- AUTO-SAVE FUNCTIONALITY ---
            // Select all inputs that should be saved
            const formInputs = document.querySelectorAll('textarea, input[type="text"], select');
            
            // 1. Load saved data on startup
            formInputs.forEach(input => {
                const savedValue = localStorage.getItem('mla_journal_' + input.id);
                if (savedValue) {
                    input.value = savedValue;
                    // Special trigger for custom theme display
                    if (input.id === 'scripture-theme-select' && savedValue === 'Other') {
                        customThemeInputGroup.classList.remove('hidden');
                    }
                }
            });

            // Restore the generated scripture div content specifically (since it's a div, not an input)
            const savedScriptureText = localStorage.getItem('mla_journal_generated_scripture');
            if (savedScriptureText) {
                generatedScriptureDisplay.innerHTML = savedScriptureText;
            }

            // 2. Save data on input change
            const showSavedIndicator = () => {
                autoSaveIndicator.style.opacity = '1';
                setTimeout(() => { autoSaveIndicator.style.opacity = '0'; }, 2000);
            };

            formInputs.forEach(input => {
                input.addEventListener('input', () => {
                    localStorage.setItem('mla_journal_' + input.id, input.value);
                    showSavedIndicator();
                });
                // For select boxes, listen to 'change'
                input.addEventListener('change', () => {
                    localStorage.setItem('mla_journal_' + input.id, input.value);
                    showSavedIndicator();
                });
            });

            // Save the generated scripture div whenever it changes
            const observer = new MutationObserver(() => {
                localStorage.setItem('mla_journal_generated_scripture', generatedScriptureDisplay.innerHTML);
            });
            observer.observe(generatedScriptureDisplay, { childList: true, subtree: true, characterData: true });


            // Toggle custom theme input visibility
            scriptureThemeSelect.addEventListener('change', () => {
                if (scriptureThemeSelect.value === 'Other') {
                    customThemeInputGroup.classList.remove('hidden');
                } else {
                    customThemeInputGroup.classList.add('hidden');
                    customScriptureThemeInput.value = ''; 
                    localStorage.setItem('mla_journal_custom-scripture-theme', ''); // Clear from storage too
                }
            });

            // Function to generate scripture using Gemini API
            async function generateScripture() {
                let selectedTheme = scriptureThemeSelect.value;
                if (selectedTheme === 'Other') {
                    selectedTheme = customScriptureThemeInput.value.trim();
                }

                if (!selectedTheme) {
                    generatedScriptureDisplay.innerHTML = '<p class="text-red-500">Please select a theme or specify a custom theme.</p>';
                    return;
                }

                generatedScriptureDisplay.innerHTML = ''; 
                scriptureLoadingSpinner.classList.remove('hidden'); 
                generateScriptureBtn.disabled = true; 

                const prompt = `Provide a short, relevant scripture passage about ${selectedTheme} from the ESV Bible, including the verse numbers and text, formatted with line breaks.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                
                // --- INSERT YOUR API KEY HERE ---
                const apiKey = "AIzaSyBOgBAjhyjmTjV6aeUPpn3YsQYz4ESMDHc"; 
                // --------------------------------

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        generatedScriptureDisplay.innerHTML = text.replace(/\n/g, '<br>'); 
                        // It will auto-save due to the MutationObserver added above
                    } else {
                        generatedScriptureDisplay.innerHTML = '<p class="text-red-500">Could not generate scripture. Please try again.</p>';
                    }
                } catch (error) {
                    generatedScriptureDisplay.innerHTML = '<p class="text-red-500">Error generating scripture. Please check your connection or API key.</p>';
                    console.error('Error calling Gemini API:', error);
                } finally {
                    scriptureLoadingSpinner.classList.add('hidden'); 
                    generateScriptureBtn.disabled = false; 
                }
            }

            generateScriptureBtn.addEventListener('click', generateScripture);

            // Function to collect all journal entry data
            const collectJournalData = () => {
                const scriptureText = generatedScriptureDisplay.textContent;
                let effectiveTheme = scriptureThemeSelect.value;
                if (effectiveTheme === 'Other') {
                    effectiveTheme = customScriptureThemeInput.value.trim() || 'Custom Theme (Not Specified)';
                } else if (effectiveTheme === '') {
                    effectiveTheme = 'Not Selected';
                }

                const scriptureReflection = document.getElementById('scripture-reflection-input').value;
                const moodCheckIn = document.getElementById('mood-check-in-input').value;
                const whatHappenedToday = document.getElementById('what-happened-today-input').value;
                const spiritualSense = document.getElementById('spiritual-sense-input').value;
                const patternNoticed = document.getElementById('pattern-noticed-input').value;
                const meaningInsight = document.getElementById('meaning-insight-input').value;
                const prayerRequest = document.getElementById('prayer-request-input').value;
                const tomorrowFocus = document.getElementById('tomorrow-focus-input').value;

                let journalContent = `MLA Journal Entry ‚Äì ${formattedDate}\n\n`;

                journalContent += `üìñ Scripture Reflection\n`;
                journalContent += `Theme: ${effectiveTheme}\n`;
                journalContent += `Generated Scripture:\n${scriptureText}\n\n`;
                journalContent += `What stands out to me in this passage:\n${scriptureReflection}\n\n`;

                journalContent += `üòä Mood Check-in\nToday I feel ${moodCheckIn}\n\n`;

                journalContent += `üìÖ What Happened Today?\nNotable moments: ${whatHappenedToday}\n\n`;

                journalContent += `üïäÔ∏è What Did I Hear from God or Sense Spiritually?\nI feel God may be saying/showing me ${spiritualSense}\n\n`;

                journalContent += `üß† Self-Awareness + Insight\nI noticed a pattern or thought: ${patternNoticed}\n`;
                journalContent += `This could mean: ${meaningInsight}\n\n`;

                journalContent += `üôè Next Step or Prayer\nLord, I need help with: ${prayerRequest}\n`;
                journalContent += `Tomorrow I want to: ${tomorrowFocus}\n`;

                return journalContent;
            };

            const downloadJournalEntry = (content, filename) => {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            };

            saveButton.addEventListener('click', () => {
                const journalContent = collectJournalData();
                const filename = `MLA_Journal_${dateForFilename}.txt`;
                downloadJournalEntry(journalContent, filename);
                saveModal.style.display = 'flex';
            });

            // Clear Button Logic
            clearButton.addEventListener('click', () => {
                if (confirm("Are you sure you want to clear the form? This will remove all text and reset the page for a new entry.")) {
                    // 1. Clear textareas and inputs
                    formInputs.forEach(input => {
                        input.value = '';
                        localStorage.removeItem('mla_journal_' + input.id);
                    });
                    
                    // 2. Clear generated scripture
                    generatedScriptureDisplay.innerHTML = 'Select a theme (or specify \'Other\') and click "Generate Scripture" to get a passage.';
                    localStorage.removeItem('mla_journal_generated_scripture');

                    // 3. Reset select to default
                    scriptureThemeSelect.value = '';
                    customThemeInputGroup.classList.add('hidden');
                    
                    alert("Form cleared and ready for a new entry!");
                }
            });

            closeModalBtn.addEventListener('click', () => { saveModal.style.display = 'none'; });
            okModalBtn.addEventListener('click', () => { saveModal.style.display = 'none'; });
            window.addEventListener('click', (event) => {
                if (event.target == saveModal) {
                    saveModal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
